<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrAI - Luy·ªán Ph√°t √Çm v·ªõi AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;700&family=Exo+2:wght@700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --accent-gradient: linear-gradient(135deg, #22d3ee, #14b8a6);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(241, 245, 249, 0.9);
            --tooltip-bg: #1e293b;
            --tooltip-text: #ffffff;
            --tooltip-border: #334155;
        }

        html.dark {
            --bg-primary: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-gradient: linear-gradient(135deg, #67e8f9, #5eead4);
            --glass-bg: rgba(15, 23, 42, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: rgba(30, 41, 59, 0.7);
            --tooltip-bg: #1e293b;
            --tooltip-text: #f8fafc;
            --tooltip-border: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            background-image: url('https://placehold.co/1920x1080/e0f2f1/b2dfdb?text=PrAI');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        html.dark body {
             background-image: url('https://placehold.co/1920x1080/0f172a/1e293b?text=PrAI');
        }

        .font-logo {
            font-family: 'Exo 2', sans-serif;
        }

        #simple-ipa-text, #detailed-ipa-text, .phoneme, .ipa-text {
            font-family: 'Noto Sans', sans-serif;
        }
        
        .phoneme {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }
        
        .phoneme:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .tooltip {
            visibility: hidden; opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translate(-50%, 10px);
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            border: 1px solid var(--tooltip-border);
            z-index: 20;
        }
        
        .has-tooltip:hover .tooltip {
            visibility: visible; opacity: 1;
            transform: translate(-50%, -5px);
        }
        
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        
        .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.07);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Light Mode Buttons */
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary { background-color: #14b8a6; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #0d9488; }
        .btn-primary { background-color: #0891b2; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0e7490; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-warning { background-color: #f97316; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #ea580c; }
        .btn-replay { background-color: #2dd4bf; color: white; }
        .btn-replay:hover:not(:disabled) { background-color: #14b8a6; }

        /* Dark Mode Button Overrides */
        html.dark .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        html.dark .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4); }
        html.dark .btn-secondary { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        html.dark .btn-secondary:hover:not(:disabled) { background: linear-gradient(135deg, #0d9488, #0f766e); box-shadow: 0 10px 25px rgba(20, 184, 166, 0.4); }
        html.dark .btn-primary { background: linear-gradient(135deg, #0891b2, #0e7490); }
        html.dark .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #0e7490, #155e75); box-shadow: 0 10px 25px rgba(8, 145, 178, 0.4); }
        html.dark .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        html.dark .btn-danger:hover:not(:disabled) { background: linear-gradient(135deg, #dc2626, #b91c1c); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
        html.dark .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        html.dark .btn-warning:hover:not(:disabled) { background: linear-gradient(135deg, #d97706, #b45309); box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4); }
        
        .btn-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-focus { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-focus:focus { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2); }
        
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px var(--shadow-color); }

        /* New Loader Styles */
        .progress-bar {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background: var(--accent-gradient);
            background-size: 200% 200%;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
            animation: gradient-animation 2s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="w-full max-w-3xl mx-auto">
        <!-- Header Section -->
        <header class="text-center mb-8 fade-in relative">
            <h1 class="text-6xl md:text-7xl font-bold gradient-text mb-4 font-logo">PrAI</h1>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-secondary">
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Main Card -->
        <main class="glass-effect rounded-3xl p-6 md:p-10 space-y-8 card-hover slide-up">
            <!-- Input Section -->
            <section class="space-y-4">
                <div>
                    <label for="text-input" class="block text-lg font-semibold text-primary mb-3">Nh·∫≠p t·ª´, c·ª•m t·ª´ ho·∫∑c c√¢u:</label>
                    <textarea id="text-input" rows="3" maxlength="250" class="w-full glass-effect p-4 bg-input-bg border-border-color rounded-xl text-primary placeholder-text-secondary focus:ring-2 focus:ring-blue-500 transition-all input-focus resize-none" placeholder="V√≠ d·ª•: an apple, what are you doing..."></textarea>
                    <div id="char-counter" class="text-right text-sm text-secondary mt-1">0 / 250</div>
                    <div class="mt-4 flex flex-col md:flex-row md:items-center gap-4">
                        <div class="flex-grow">
                            <label for="accent-select" class="block text-sm font-medium text-secondary mb-1">Ch·ªçn gi·ªçng:</label>
                            <select id="accent-select" class="w-full glass-effect p-3 bg-input-bg border-border-color rounded-xl text-primary focus:ring-2 focus:ring-teal-500 transition-all input-focus">
                                <option value="British English" selected>Anh - Anh (BrE)</option>
                                <option value="American English">Anh - M·ªπ (AmE)</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0 flex gap-2 md:self-end">
                            <button id="transcribe-btn" class="btn btn-success font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 w-1/2 md:w-auto">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                <span class="text">Phi√™n √¢m</span>
                                <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                            </button>
                            <button id="random-practice-btn" class="btn btn-secondary font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 w-1/2 md:w-auto">
                               <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                                <span class="text">Th·ª≠ c√¢u</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- IPA & Controls Section -->
            <section id="controls-section" class="hidden space-y-6">
                 <div class="space-y-3">
                     <div class="flex items-end gap-3">
                         <div class="flex-grow">
                             <h3 class="font-semibold text-secondary text-md mb-1">Phi√™n √¢m c∆° b·∫£n</h3>
                             <p id="simple-ipa-text" class="text-lg text-primary bg-input-bg p-3 rounded-lg flex items-center tracking-wider border border-border-color"></p>
                         </div>
                         <button id="listen-clear-btn" class="btn btn-primary w-14 flex-shrink-0 rounded-xl flex items-center justify-center shadow-lg py-3">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                             <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                         </button>
                     </div>
                     <div class="flex items-end gap-3">
                         <div class="flex-grow">
                             <h3 class="font-semibold text-teal-500 dark:text-teal-400 text-md mb-1">Phi√™n √¢m t·ª± nhi√™n</h3>
                             <p id="detailed-ipa-text" class="text-xl text-teal-600 dark:text-teal-300 bg-teal-500/10 p-3 rounded-lg flex items-center tracking-wider border border-teal-500/20"></p>
                         </div>
                          <button id="listen-natural-btn" class="btn btn-primary w-14 flex-shrink-0 rounded-xl flex items-center justify-center shadow-lg py-3">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                         </button>
                     </div>
                 </div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="record-btn" class="btn btn-danger font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                        <span class="text">Ghi √¢m</span>
                    </button>
                    <button id="listen-again-btn" disabled class="btn bg-gray-300 text-gray-500 dark:bg-gray-600 dark:text-gray-400 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        <span>Nghe l·∫°i</span>
                    </button>
                </div>
            </section>

            <!-- Waveform & Loader -->
            <div id="waveform-container" class="hidden h-20 glass-effect rounded-lg flex items-center justify-center p-2">
                 <canvas id="waveform" class="w-full h-full"></canvas>
                 <p id="recording-text" class="hidden absolute text-white bg-black/50 px-3 py-1 rounded-lg font-medium">ƒêang ghi √¢m...</p>
            </div>
            <div id="loader" class="text-center hidden py-4 flex flex-col items-center justify-center">
                <div class="progress-bar w-full max-w-xs">
                    <div class="progress-bar-inner"></div>
                </div>
                <p id="progress-text" class="text-secondary mt-4">PrAI ƒëang l·∫Øng nghe v√† ph√¢n t√≠ch...</p>
                <p id="fun-fact" class="text-sm text-gray-400 mt-6 italic hidden"></p>
            </div>

            <!-- Analysis Results -->
            <section id="analysis-results" class="hidden space-y-6 pt-4 border-t border-border-color">
                <div class="glass-effect p-6 rounded-xl space-y-4">
                    <h3 class="font-bold text-primary text-xl">K·∫øt qu·∫£ Ph√¢n t√≠ch:</h3>
                    <p class="text-2xl font-bold text-primary">ƒêi·ªÉm t·ªïng quan: <span id="overall-score" class="text-green-500"></span></p>
                    <div>
                        <h4 class="font-semibold text-secondary mb-2">Ph√¢n t√≠ch √Çm v·ªã:</h4>
                        <div id="phoneme-analysis" class="flex flex-wrap gap-2 p-3 bg-input-bg rounded-lg"></div>
                        <p class="text-xs text-secondary mt-2">Ch·∫°m ho·∫∑c di chu·ªôt qua c√°c √¢m v·ªã m√†u v√†ng/ƒë·ªè ƒë·ªÉ xem h∆∞·ªõng d·∫´n.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-secondary mb-2">Ph√¢n t√≠ch Tr·ªçng √¢m:</h4>
                        <div id="stress-analysis" class="p-3 bg-input-bg rounded-lg"></div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="show-more-btn" class="hidden bg-indigo-100 text-indigo-600 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-all text-sm">
                        Th√¥ng tin th√™m
                    </button>
                </div>

                <div id="advanced-analysis" class="hidden space-y-4 glass-effect p-6 rounded-xl">
                    <h3 class="font-bold text-primary text-xl">Ph√¢n t√≠ch N√¢ng cao:</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-teal-600 dark:text-teal-400 mb-2">Ng·ªØ ƒëi·ªáu (Intonation):</h4>
                            <div id="intonation-analysis" class="p-3 bg-input-bg rounded-lg"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold text-cyan-600 dark:text-cyan-400 mb-2">N·ªëi √¢m (Connected Speech):</h4>
                            <div id="connected-speech-analysis" class="p-3 bg-input-bg rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>

                 <div id="practice-suggestions" class="hidden glass-effect p-6 rounded-xl">
                    <h3 class="font-bold text-primary text-xl mb-4">Xem v√≠ d·ª• th·ª±c t·∫ø:</h3>
                    <div id="suggestion-links" class="flex flex-col sm:flex-row gap-3 mt-2"></div>
                </div>
            </section>
        </main>

        <!-- Message Box -->
        <div id="message-box" class="fixed bottom-5 right-5 hidden p-4 rounded-xl text-sm z-50 shadow-lg"></div>
        <audio id="replay-audio" class="hidden"></audio>

        <!-- Footer -->
        <footer class="text-center mt-8 text-secondary text-sm">
            <p>¬© 2025 PrAI - Ph√°t tri·ªÉn b·ªüi Mr B·∫£o v·ªõi t√¨nh y√™u d√†nh cho vi·ªác h·ªçc ti·∫øng Anh</p>
        </footer>
    </div>

    <script type="module">
        // DOM Elements
        const textInput = document.getElementById('text-input');
        const accentSelect = document.getElementById('accent-select');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const listenNaturalBtn = document.getElementById('listen-natural-btn');
        const listenClearBtn = document.getElementById('listen-clear-btn');
        const recordBtn = document.getElementById('record-btn');
        const listenAgainBtn = document.getElementById('listen-again-btn');
        const randomPracticeBtn = document.getElementById('random-practice-btn');
        const controlsSection = document.getElementById('controls-section');
        const loader = document.getElementById('loader');
        const ipaDisplay = document.getElementById('ipa-display');
        const simpleIpaText = document.getElementById('simple-ipa-text');
        const detailedIpaText = document.getElementById('detailed-ipa-text');
        const analysisResults = document.getElementById('analysis-results');
        const overallScore = document.getElementById('overall-score');
        const phonemeAnalysis = document.getElementById('phoneme-analysis');
        const stressAnalysis = document.getElementById('stress-analysis');
        const practiceSuggestions = document.getElementById('practice-suggestions');
        const suggestionLinks = document.getElementById('suggestion-links');
        const messageBox = document.getElementById('message-box');
        const waveformContainer = document.getElementById('waveform-container');
        const waveformEl = document.getElementById('waveform');
        const recordingText = document.getElementById('recording-text');
        const replayAudio = document.getElementById('replay-audio');
        const funFactEl = document.getElementById('fun-fact');
        const showMoreBtn = document.getElementById('show-more-btn');
        const advancedAnalysis = document.getElementById('advanced-analysis');
        const intonationAnalysis = document.getElementById('intonation-analysis');
        const connectedSpeechAnalysis = document.getElementById('connected-speech-analysis');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const progressText = document.getElementById('progress-text');
        const charCounter = document.getElementById('char-counter');

        // State variables
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let standardIPA = '';
        let ipaForText = ''; 
        let audioContext;
        let analyser;
        let waveformAnimationId;
        let lastRecordingBlob = null;
        let soundDetected = false;
        let ipaLoadingInterval;
        let lastTTSAudioNatural = null;
        let lastTTSTextNatural = '';
        let lastTTSAccentNatural = '';
        let lastTTSAudioClear = null;
        let lastTTSTextClear = '';
        let lastTTSAccentClear = '';
        let fetchIpaRequestID = 0; // To manage concurrent IPA fetch requests
        let progressInterval;
        
        // --- DATA & CONFIG ---
        const funFacts = [
            "'Ough' c√≥ th·ªÉ ƒë∆∞·ª£c ph√°t √¢m theo 10 c√°ch kh√°c nhau.",
            "√Çm c√¢m (silent letters) l√† di t√≠ch l·ªãch s·ª≠ t·ª´ c√°c ng√¥n ng·ªØ kh√°c.",
            "'Pronunciation' (ph√°t √¢m) tr·ªõ tr√™u l·∫°i l√† t·ª´ b·ªã ph√°t √¢m sai nhi·ªÅu nh·∫•t.",
            "Ti·∫øng Anh c√≥ t·ªõi 20 √¢m nguy√™n √¢m theo h·ªá th·ªëng IPA, nhi·ªÅu h∆°n h·∫ßu h·∫øt c√°c ng√¥n ng·ªØ kh√°c.",
            "'Strengths' l√† t·ª´ d√†i nh·∫•t ch·ªâ c√≥ m·ªôt nguy√™n √¢m.",
            "'Rhythms' l√† t·ª´ d√†i nh·∫•t kh√¥ng c√≥ nguy√™n √¢m (a, e, i, o, u).",
            "'Bookkeeper' l√† t·ª´ duy nh·∫•t c√≥ ba c·∫∑p ch·ªØ c√°i l·∫∑p l·∫°i li√™n ti·∫øp.",
            "Crutch Words (T·ª´ ƒë·ªám): Nh·ªØng t·ª´ nh∆∞ 'like', 'actually', 'basically', 'literally' th∆∞·ªùng ƒë∆∞·ª£c d√πng l√†m t·ª´ ƒë·ªám trong giao ti·∫øp h√†ng ng√†y m√† kh√¥ng th√™m nhi·ªÅu √Ω nghƒ©a.",
            "C√¢u 'Buffalo buffalo Buffalo buffalo buffalo buffalo Buffalo buffalo.' l√† m·ªôt c√¢u ƒë√∫ng ng·ªØ ph√°p, s·ª≠ d·ª•ng ba nghƒ©a c·ªßa t·ª´ 'buffalo' (tr√¢u, th√†nh ph·ªë Buffalo, v√† ƒë·ªông t·ª´ 'do·∫° n·∫°t').",
            "√Çm 'gh' kh√≥ ƒëo√°n: 'gh' c√≥ th·ªÉ ƒë∆∞·ª£c ph√°t √¢m l√† /f/ nh∆∞ trong 'enough', /g/ nh∆∞ trong 'ghost', ho·∫∑c c√¢m nh∆∞ trong 'though'.",
            "T·ª´ 'set' gi·ªØ k·ª∑ l·ª•c: T·ª´ 'set' c√≥ nhi·ªÅu ƒë·ªãnh nghƒ©a nh·∫•t trong ti·∫øng Anh, v·ªõi h∆°n 430 nghƒ©a kh√°c nhau trong T·ª´ ƒëi·ªÉn Oxford.",
            "'Queueing' l√† t·ª´ duy nh·∫•t c√≥ nƒÉm nguy√™n √¢m ƒëi li·ªÅn nhau.",
            "'I am' l√† c√¢u ho√†n ch·ªânh ng·∫Øn nh·∫•t trong ti·∫øng Anh.",
            "C√¢u 'The quick brown fox jumps over the lazy dog' ch·ª©a t·∫•t c·∫£ 26 ch·ªØ c√°i trong b·∫£ng ch·ªØ c√°i.",
            "Kh√¥ng c√≥ t·ª´ n√†o trong ti·∫øng Anh v·∫ßn v·ªõi 'month', 'orange', 'silver' hay 'purple'.",
            "'Uncopyrightable' l√† t·ª´ d√†i nh·∫•t kh√¥ng l·∫∑p l·∫°i b·∫•t k·ª≥ ch·ªØ c√°i n√†o.",
            "T·ª´ d√†i nh·∫•t trong t·ª´ ƒëi·ªÉn l√† 'pneumonoultramicroscopicsilicovolcanoconiosis' (m·ªôt lo·∫°i b·ªánh ph·ªïi).",
            "Shakespeare ƒë√£ s√°ng t·∫°o ra h∆°n 1,700 t·ª´ cho ti·∫øng Anh, v√≠ d·ª• nh∆∞ 'eyeball', 'swagger', 'bedazzled'.",
            "T·ª´ 'lol' (laughing out loud) ƒë√£ ƒë∆∞·ª£c th√™m v√†o t·ª´ ƒëi·ªÉn Oxford v√†o nƒÉm 2011.",
            "'SWIMS' khi l·ªôn ng∆∞·ª£c l·∫°i v·∫´n l√† 'SWIMS'.",
            "'Stewardesses' l√† t·ª´ d√†i nh·∫•t c√≥ th·ªÉ g√µ ch·ªâ b·∫±ng tay tr√°i tr√™n b√†n ph√≠m QWERTY.",
            "T·ª´ 'dreamt' l√† t·ª´ duy nh·∫•t k·∫øt th√∫c b·∫±ng '-mt'.",
            "Ch·ªØ c√°i ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu nh·∫•t l√† 'e', v√† ch·ªØ c√°i b·∫Øt ƒë·∫ßu nhi·ªÅu t·ª´ nh·∫•t l√† 's'."
        ];
        
        const practiceSentences = [
            "What are you doing?", "It's a piece of cake.", "I'll call you back later.",
            "How's it going?", "Can I have a bottle of water, please?", "It's a beautiful day, isn't it?",
            "I'm looking forward to it.", "Could you please repeat that?", "Where is the nearest station?",
            "Can you help me, please?", "I don't understand.", "Could you repeat that, please?",
            "Could you please talk slower?", "What does this mean?", "How do you spell that?",
            "What do you think?", "That sounds great.", "That's a good idea.", "I have no idea.",
            "I'm not sure.", "Could you give me a hand with this?", "Piece of cake", "Break a leg",
            "Under the weather", "Hit the books", "Call it a day", "What have you been up to?",
            "Is everything okay?", "Take care.", "Let me know if you need anything.", "I'm here for you.",
            "Can I have your attention, please?", "Let's get down to business.", "How much is this?",
            "Do you have this in a different size/color?", "I'm just browsing, thanks.", "I'll take it.",
            "Keep the change.", "Could I have the bill, please?", "It's on me.", "Let's split the bill."
        ];

        // API Configuration - Replace with your own API key if running outside the original environment.
        const apiKey = ""; 
        const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;


        // --- UTILITY FUNCTIONS ---

        function showMessage(message, type = 'info') {
            const colors = {
                'info': 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/80 dark:text-blue-300 dark:border-blue-500/30',
                'success': 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/80 dark:text-green-300 dark:border-green-500/30',
                'warning': 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/80 dark:text-yellow-300 dark:border-yellow-500/30',
                'error': 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/80 dark:text-red-300 dark:border-red-500/30'
            };
            messageBox.className = `fixed bottom-5 right-5 p-4 rounded-xl text-sm z-50 shadow-lg border ${colors[type]} fade-in`;
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function handleApiError(error) {
            console.error("API Error:", error);
            if (error.message && (error.message.includes('429') || error.message.toLowerCase().includes('quota'))) {
                showMessage('H·ªá th·ªëng ƒëang b·∫≠n. B·∫°n vui l√≤ng th·ª≠ l·∫°i sau nh√©.', 'error');
            } else {
                showMessage(`ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        function setButtonLoading(button, isLoading) {
            const textEl = button.querySelector('.text') || button.querySelector('span');
            const iconEl = button.querySelector('.icon');
            const spinnerEl = button.querySelector('.btn-spinner');
            button.disabled = isLoading;
            if (isLoading) {
                if(textEl) textEl.classList.add('hidden');
                if(iconEl) iconEl.classList.add('hidden');
                if(spinnerEl) spinnerEl.classList.remove('hidden');
            } else {
                if(textEl) textEl.classList.remove('hidden');
                if(iconEl) iconEl.classList.remove('hidden');
                if(spinnerEl) spinnerEl.classList.add('hidden');
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const dataSize = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- API & CORE LOGIC ---

        async function fetchWithBackoff(url, options, maxRetries = 4) {
             let delay = 1000; // start with 1 second
             for (let i = 0; i < maxRetries; i++) {
                 try {
                     const response = await fetch(url, options);
                     if (response.status === 429 || response.status >= 500) {
                         if (i === maxRetries - 1) {
                             const errorBody = await response.json().catch(() => ({}));
                             throw new Error(`API Error: ${response.status}. ${errorBody.error?.message || 'Server error after multiple retries.'}`);
                         }
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2; 
                         continue; 
                     }
                     if (!response.ok) {
                          const errorBody = await response.json().catch(() => ({}));
                          throw new Error(`API Error: ${response.status}. ${errorBody.error?.message || 'An unknown error occurred.'}`);
                     }
                     return await response.json();
                 } catch (error) {
                     if (i === maxRetries - 1) {
                         throw error;
                     }
                     await new Promise(resolve => setTimeout(resolve, delay));
                     delay *= 2;
                 }
             }
         }
        
        function startIpaLoadingAnimation() {
            clearInterval(ipaLoadingInterval);
            const ipaSymbols = ['…ô', ' É', 't', 'd', 'k', '√¶', 'iÀê', 'Œ∏', '√∞', '≈ã', 'w', 'j', 'r', 'l', 's', 'z'];
            let i = 0;
            ipaLoadingInterval = setInterval(() => {
                const symbolSequence = Array(5).fill(0).map((_, j) => ipaSymbols[(i + j) % ipaSymbols.length]).join(' ');
                simpleIpaText.textContent = `/ ${symbolSequence} /`;
                detailedIpaText.textContent = `[ ${symbolSequence} ]`;
                i = (i + 1) % ipaSymbols.length;
            }, 100);
        }

        function stopIpaLoadingAnimation() {
            clearInterval(ipaLoadingInterval);
        }

        async function fetchAndDisplayIPA() {
            fetchIpaRequestID++;
            const currentRequestID = fetchIpaRequestID;

            const text = textInput.value.trim();
            if (!text) {
                resetAll();
                return false;
            }
            
            if (ipaForText === text && accentSelect.value === document.body.dataset.accent) {
                controlsSection.classList.remove('hidden');
                return true;
            }

            const accent = accentSelect.value;
            const combinedPrompt = `For the phrase "${text}" in ${accent}, provide two IPA transcriptions in a single JSON object.
            1.  'simple': A standard transcription with each word transcribed individually.
            2.  'detailed': A natural, connected speech transcription, including features like linking (liaison), elision, assimilation, and **intrusion (/j/, /w/, /r/)** where phonologically appropriate.
            Respond with ONLY the JSON object. Example for "go on": {"simple": "/…°…ô ä …ín/", "detailed": "/…°…ô äw…ín/"}`;
            
            setButtonLoading(transcribeBtn, true);
            controlsSection.classList.remove('hidden');
            startIpaLoadingAnimation();
            
            try {
                const payload = { 
                    contents: [{ parts: [{ text: combinedPrompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetchWithBackoff(TEXT_API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (currentRequestID !== fetchIpaRequestID) return false;

                const resultText = response.candidates[0].content.parts[0].text;
                const resultJson = JSON.parse(resultText);

                standardIPA = resultJson.detailed;
                ipaForText = text;
                document.body.dataset.accent = accent;
                simpleIpaText.textContent = resultJson.simple;
                detailedIpaText.textContent = resultJson.detailed;
                
                return true;
            } catch (error) {
                if (currentRequestID === fetchIpaRequestID) {
                    handleApiError(error);
                    resetAll();
                }
                return false;
            } finally {
                if (currentRequestID === fetchIpaRequestID) {
                    stopIpaLoadingAnimation();
                    setButtonLoading(transcribeBtn, false);
                }
            }
        }

        async function handleListen(type, button) {
            const text = textInput.value.trim();
            const accent = accentSelect.value;
            if (!text) {
                showMessage('Vui l√≤ng nh·∫≠p t·ª´ ho·∫∑c c√¢u ƒë·ªÉ nghe.', 'warning');
                return;
            }
            
            // Check cache
            const isNatural = type === 'natural';
            const cachedAudio = isNatural ? lastTTSAudioNatural : lastTTSAudioClear;
            const cachedText = isNatural ? lastTTSTextNatural : lastTTSTextClear;
            const cachedAccent = isNatural ? lastTTSAccentNatural : lastTTSAccentClear;

            if (cachedAudio && cachedText === text && cachedAccent === accent) {
                cachedAudio.play();
                return;
            }

            const ipaFetched = await fetchAndDisplayIPA();
            if (!ipaFetched) return;

            setButtonLoading(button, true);
            try {
                const prompt = isNatural 
                    ? `Say clearly in ${accent}: ${text}` 
                    : `Say very clearly, with only a slight pause between each word, in ${accent}: ${text}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseModalities: ["AUDIO"] },
                    model: TTS_MODEL
                };

                const data = await fetchWithBackoff(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const audioPart = data?.candidates?.[0]?.content?.parts?.[0];
                if (audioPart && audioPart.inlineData) {
                    const audioData = audioPart.inlineData.data;
                    const mimeType = audioPart.inlineData.mimeType;
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                    // Store in cache
                    if(isNatural) {
                        lastTTSAudioNatural = audio;
                        lastTTSTextNatural = text;
                        lastTTSAccentNatural = accent;
                    } else {
                        lastTTSAudioClear = audio;
                        lastTTSTextClear = text;
                        lastTTSAccentClear = accent;
                    }
                } else {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu √¢m thanh h·ª£p l·ªá.");
                }
            } catch (error) {
                handleApiError(error);
            } finally {
                setButtonLoading(button, false);
            }
        }
        
        function startProgressSimulation() {
            const progressBarInner = document.querySelector('.progress-bar-inner');
            if (!progressBarInner) return;
            
            let width = 0;
            progressBarInner.style.width = '0%';
            
            clearInterval(progressInterval);

            progressInterval = setInterval(() => {
                if (width < 95) {
                    width += Math.random() * 2;
                } else {
                    clearInterval(progressInterval);
                }
                progressBarInner.style.width = Math.min(width, 95) + '%';
            }, 100);
        }

        function stopProgressSimulation() {
            clearInterval(progressInterval);
            const progressBarInner = document.querySelector('.progress-bar-inner');
            if (progressBarInner) {
                progressBarInner.style.width = '100%';
            }
        }

        async function analyzeAudio() {
            if (audioChunks.length === 0) return;
            lastRecordingBlob = new Blob(audioChunks, { type: 'audio/webm' });
            listenAgainBtn.disabled = false;
            listenAgainBtn.classList.remove('bg-gray-300', 'text-gray-500', 'dark:bg-gray-600', 'dark:text-gray-400');
            listenAgainBtn.classList.add('btn-replay');

            loader.classList.remove('hidden');
            progressText.textContent = "PrAI ƒëang l·∫Øng nghe v√† ph√¢n t√≠ch...";
            startProgressSimulation();
            funFactEl.textContent = `üí° ${funFacts[Math.floor(Math.random() * funFacts.length)]}`;
            funFactEl.classList.remove('hidden');
            
            const ipaFetched = await fetchAndDisplayIPA();
            if (!ipaFetched) {
                loader.classList.add('hidden');
                stopProgressSimulation();
                funFactEl.classList.add('hidden');
                showMessage('Kh√¥ng th·ªÉ ph√¢n t√≠ch v√¨ kh√¥ng l·∫•y ƒë∆∞·ª£c phi√™n √¢m chu·∫©n.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.readAsDataURL(lastRecordingBlob);
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                const isSentence = textInput.value.trim().includes(' ');
                
                // --- AI PROMPT ENHANCEMENT ---
                // This prompt is now informed by the user-provided documents.
                const prompt = {
                    "role": "You are PrAI, a world-class phonetician specializing in American (AmE) and British (BrE) English, acting as an encouraging tutor for Vietnamese learners.",
                    "knowledge_base": [
                        "Ph√°t √Çm Chu·∫©n Ti·∫øng Anh-Anh v√† Anh-M·ªπ trong Th·∫ø K·ª∑ 21 (user-provided document).",
                        "Shaping Learners‚Äô Pronunciation: Teaching the Connected Speech of North American English (user-provided document).",
                        "English Phonetics and Pronunciation Practice (user-provided document).",
                        "Oxford BBC Guide To Pronunciation (user-provided document).",
                        "English Pronunciation Instruction: Research-based insights (user-provided document)."
                    ],
                    "context": {
                        "text_to_pronounce": textInput.value.trim(),
                        "target_accent": accentSelect.value === 'American English' ? 'AmE' : 'BrE',
                        "standard_ipa": standardIPA,
                        "is_sentence": isSentence,
                        "phonetic_guidelines": {
                            "instruction": "Your analysis MUST strictly adhere to the phonetic norms of the 'target_accent' as detailed in the user-provided documents. Your feedback must be gentle, encouraging, detailed, positive, and constructive. It must be scientifically rigorous and natural-sounding.",
                            "vietnamese_learner_focus": [
                                "Pay special attention to common Vietnamese L1 interference patterns: final consonant deletion (e.g., 'nice' -> /na…™/), incorrect vowel length, and difficulty with consonant clusters.",
                                "Analyze connected speech phenomena (assimilation, elision, linking) based on the 'Shaping Learners' Pronunciation' document."
                            ]
                        }
                    },
                    "task": `First, determine if the audio contains discernible English speech. If not, set 'speech_detected' to false and return immediately. If speech is detected, perform a scientifically rigorous analysis based on the 'phonetic_guidelines' and your extensive 'knowledge_base'.
                    1.  **Scoring:** Provide an 'overall_score' (0-100) based on phonetic proximity to a native speaker of the 'target_accent'. Do NOT penalize correct accent-specific variations.
                    2.  **Analysis & Feedback:** Analyze phonemes, stress, connected speech, and intonation. Adopt a gentle and encouraging tone. Explain errors by referencing L1 interference (e.g., "ƒê√¢y l√† m·ªôt l·ªói ph·ªï bi·∫øn c·ªßa ng∆∞·ªùi Vi·ªát v√¨ √¢m cu·ªëi /s/ th∆∞·ªùng kh√¥ng ƒë∆∞·ª£c ph√°t √¢m..."). Prioritize feedback based on impact on intelligibility: 1. Final Consonants, 2. Sentence Rhythm & Connected Speech, 3. Key Consonants (/Œ∏, √∞,  É,  í/), 4. Vowels.
                    Return the result in the specified JSON format.`,
                    "output_format_instruction": {
                        "format": "JSON",
                        "schema": {
                            "speech_detected": "boolean",
                            "overall_score": "number | null",
                            "user_ipa": "string | null",
                            "phoneme_analysis": "[ { \"phoneme\": \"string\", \"status\": \"string ('correct', 'approximate', 'incorrect')\", \"feedback\": \"string | null\" } ] | null",
                            "stress_analysis": "{ \"correctly_placed\": \"boolean\", \"feedback\": \"string\" } | null",
                            "advanced_analysis?": "{ \"intonation\": { \"feedback\": \"string\" }, \"connected_speech\": [ { \"type\": \"string\", \"rule\": \"string\", \"example\": \"string\", \"explanation\": \"string\", \"feedback\": \"string\" } ] } | null",
                            "practice_suggestions": "{ \"youglish_us\": \"string\", \"youglish_uk\": \"string\" } | null"
                        }
                    }
                };

                const payload = {
                    contents: [ { role: "user", parts: [ { text: JSON.stringify(prompt) }, { inlineData: { mimeType: "audio/webm", data: base64Audio } } ] } ],
                    generationConfig: { responseMimeType: "application/json" }
                };

                try {
                    const data = await fetchWithBackoff(TEXT_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const resultText = data.candidates[0].content.parts[0].text;
                    const resultJson = JSON.parse(resultText);
                    displayResults(resultJson);
                } catch (error) {
                    handleApiError(error);
                } finally {
                    stopProgressSimulation();
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        funFactEl.classList.add('hidden');
                    }, 500);
                }
            };
        }

        function displayResults(data) {
            if (!data.speech_detected || data.overall_score === null) {
                showMessage("PrAI kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i trong b·∫£n ghi √¢m. Vui l√≤ng th·ª≠ l·∫°i v√† n√≥i to, r√µ h∆°n nh√©.", 'warning');
                analysisResults.classList.add('hidden');
                return;
            }

            analysisResults.classList.remove('hidden');
            overallScore.textContent = `${data.overall_score}/100`;
            overallScore.className = `font-bold ${data.overall_score > 85 ? 'text-green-500' : data.overall_score > 70 ? 'text-yellow-500' : 'text-red-500'}`;
            
            phonemeAnalysis.innerHTML = '';
            if (data.phoneme_analysis) {
                data.phoneme_analysis.forEach(p => {
                    const phonemeEl = document.createElement('div');
                    phonemeEl.textContent = p.phoneme;
                    phonemeEl.className = 'phoneme p-2 rounded-md text-lg cursor-pointer relative shadow-sm';
                    
                    if (p.status === 'correct') { 
                        phonemeEl.classList.add('bg-green-100', 'dark:bg-green-500/20', 'text-green-700', 'dark:text-green-300');
                    } else if (p.status === 'approximate') { 
                        phonemeEl.classList.add('bg-yellow-100', 'dark:bg-yellow-500/20', 'text-yellow-700', 'dark:text-yellow-300', 'has-tooltip');
                    } else { 
                        phonemeEl.classList.add('bg-red-100', 'dark:bg-red-500/20', 'text-red-700', 'dark:text-red-300', 'has-tooltip');
                    }

                    if (p.feedback) {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip absolute bottom-full left-1/2 mb-2 w-64 rounded-lg p-3 text-xs shadow-lg';
                        tooltip.textContent = p.feedback;
                        phonemeEl.appendChild(tooltip);
                    }
                    phonemeAnalysis.appendChild(phonemeEl);
                });
            }

            if (data.stress_analysis) {
                stressAnalysis.textContent = data.stress_analysis.feedback;
                stressAnalysis.className = `p-3 bg-input-bg rounded-lg ${data.stress_analysis.correctly_placed ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}`;
            }

            if (data.advanced_analysis) {
                intonationAnalysis.textContent = data.advanced_analysis.intonation.feedback;
                connectedSpeechAnalysis.innerHTML = '';
                if (data.advanced_analysis.connected_speech && data.advanced_analysis.connected_speech.length > 0) {
                    data.advanced_analysis.connected_speech.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'space-y-2';
                        itemEl.innerHTML = `
                            <h5 class="font-semibold text-indigo-600 dark:text-indigo-400">${item.type}</h5>
                            <p class="text-sm text-secondary"><strong class="font-medium text-primary">Quy t·∫Øc:</strong> ${item.rule}</p>
                            <p class="text-sm text-secondary"><strong class="font-medium text-primary">V√≠ d·ª•:</strong> <span class="ipa-text text-cyan-600 dark:text-cyan-300">${item.example}</span></p>
                            <p class="text-sm text-secondary"><strong class="font-medium text-primary">Gi·∫£i th√≠ch:</strong> ${item.explanation}</p>
                            <p class="text-sm p-2 rounded-md ${item.feedback.toLowerCase().includes('t·ªët') ? 'bg-green-100 dark:bg-green-500/10 text-green-700 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-500/10 text-yellow-700 dark:text-yellow-300'}"><strong class="font-medium text-primary">Nh·∫≠n x√©t:</strong> ${item.feedback}</p>
                        `;
                        connectedSpeechAnalysis.appendChild(itemEl);
                    });
                } else {
                    connectedSpeechAnalysis.innerHTML = '<p class="text-secondary">Kh√¥ng ph√°t hi·ªán hi·ªán t∆∞·ª£ng n·ªëi √¢m n·ªïi b·∫≠t trong c√¢u n√†y.</p>';
                }
                showMoreBtn.classList.remove('hidden');
            } else {
                showMoreBtn.classList.add('hidden');
            }

            if (data.practice_suggestions) {
                suggestionLinks.innerHTML = '';
                const { youglish_us, youglish_uk } = data.practice_suggestions;
                
                const usLink = document.createElement('a');
                usLink.href = youglish_us;
                usLink.target = '_blank';
                usLink.className = 'btn btn-danger flex-1 text-center font-semibold py-2 px-4 rounded-lg';
                usLink.textContent = 'Gi·ªçng M·ªπ (YouGlish)';
                
                const ukLink = document.createElement('a');
                ukLink.href = youglish_uk;
                ukLink.target = '_blank';
                ukLink.className = 'btn btn-primary flex-1 text-center font-semibold py-2 px-4 rounded-lg';
                ukLink.textContent = 'Gi·ªçng Anh (YouGlish)';

                suggestionLinks.appendChild(usLink);
                suggestionLinks.appendChild(ukLink);
                practiceSuggestions.classList.remove('hidden');
            } else {
                practiceSuggestions.classList.add('hidden');
            }
        }
        
        // --- UI & EVENT HANDLERS ---
        
        function resetAnalysisOnly() {
            analysisResults.classList.add('hidden');
            practiceSuggestions.classList.add('hidden');
            showMoreBtn.classList.add('hidden');
            advancedAnalysis.classList.add('hidden');
            showMoreBtn.textContent = 'Th√¥ng tin th√™m';
        }

        function resetAll() {
            standardIPA = '';
            ipaForText = '';
            controlsSection.classList.add('hidden');
            resetAnalysisOnly();
            lastTTSAudioNatural = null;
            lastTTSTextNatural = '';
            lastTTSAccentNatural = '';
            lastTTSAudioClear = null;
            lastTTSTextClear = '';
            lastTTSAccentClear = '';
        }
        
        async function handleRecord() {
            if (isRecording) {
                mediaRecorder.stop();
                return;
            }
            
            if (!textInput.value.trim()) {
                showMessage('Vui l√≤ng nh·∫≠p t·ª´ ƒë·ªÉ ghi √¢m v√† ph√¢n t√≠ch.', 'warning');
                return;
            }
            
            resetAnalysisOnly();
            listenAgainBtn.disabled = true;
            listenAgainBtn.classList.remove('btn-replay');
            listenAgainBtn.classList.add('bg-gray-300', 'text-gray-500', 'dark:bg-gray-600', 'dark:text-gray-400');
            lastRecordingBlob = null;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                soundDetected = false;
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    isRecording = false;
                    stopWaveform();
                    stream.getTracks().forEach(track => track.stop());
                    recordBtn.querySelector('.text').textContent = 'Ghi √¢m';
                    recordBtn.classList.remove('btn-warning');
                    recordBtn.classList.add('btn-danger');
                    if (soundDetected) {
                        analyzeAudio();
                    } else {
                        showMessage("PrAI kh√¥ng ph√°t hi·ªán th·∫•y √¢m thanh. Vui l√≤ng th·ª≠ ghi √¢m l·∫°i nh√©.", "error");
                    }
                };
                mediaRecorder.start();
                startWaveform(stream);
                recordBtn.querySelector('.text').textContent = 'D·ª´ng';
                recordBtn.classList.remove('btn-danger');
                recordBtn.classList.add('btn-warning');
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showMessage('Kh√¥ng th·ªÉ truy c·∫≠p micro. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.', 'error');
            }
        }

        function handleListenAgain() {
            if (lastRecordingBlob) {
                const audioUrl = URL.createObjectURL(lastRecordingBlob);
                replayAudio.src = audioUrl;
                replayAudio.play();
            }
        }

        function startWaveform(stream) {
            waveformContainer.classList.remove('hidden');
            recordingText.classList.remove('hidden');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const canvas = waveformEl;
            const canvasCtx = canvas.getContext('2d');

            function draw() {
                waveformAnimationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                const averageVolume = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;
                const volumeThreshold = 15;
                if (averageVolume > volumeThreshold) {
                    soundDetected = true;
                }
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 1.5;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2.5;
                    const gradient = canvasCtx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                    gradient.addColorStop(0, '#22d3ee');
                    gradient.addColorStop(1, '#14b8a6');
                    canvasCtx.fillStyle = gradient;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimationId) cancelAnimationFrame(waveformAnimationId);
            if (audioContext && audioContext.state !== 'closed') audioContext.close();
            waveformContainer.classList.add('hidden');
            recordingText.classList.add('hidden');
        }
        
        function toggleAdvancedAnalysis() {
            const isHidden = advancedAnalysis.classList.contains('hidden');
            advancedAnalysis.classList.toggle('hidden');
            showMoreBtn.textContent = isHidden ? '·∫®n b·ªõt' : 'Th√¥ng tin th√™m';
        }

        function handleRandomPractice() {
            const randomSentence = practiceSentences[Math.floor(Math.random() * practiceSentences.length)];
            textInput.value = randomSentence;
            charCounter.textContent = `${randomSentence.length} / 250`;
            resetAll();
            fetchAndDisplayIPA();
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
        }

        // Initial setup
        function init() {
            let savedTheme = 'light';
            try {
                savedTheme = localStorage.getItem('theme') || 'light';
            } catch (e) {
                console.warn("Could not access localStorage. Defaulting to light theme.");
            }
            applyTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                try {
                    localStorage.setItem('theme', newTheme);
                } catch(e) {
                    console.warn("Could not save theme to localStorage.");
                }
                applyTheme(newTheme);
            });

            accentSelect.value = 'British English';

            textInput.addEventListener('input', () => {
                const currentLength = textInput.value.length;
                const maxLength = textInput.getAttribute('maxlength');
                charCounter.textContent = `${currentLength} / ${maxLength}`;
                resetAll();
            });
            accentSelect.addEventListener('change', () => {
                if (textInput.value.trim()) {
                    resetAll();
                    fetchAndDisplayIPA();
                }
            });
            transcribeBtn.addEventListener('click', fetchAndDisplayIPA);
            listenNaturalBtn.addEventListener('click', (e) => handleListen('natural', e.currentTarget));
            listenClearBtn.addEventListener('click', (e) => handleListen('clear', e.currentTarget));
            recordBtn.addEventListener('click', handleRecord);
            listenAgainBtn.addEventListener('click', handleListenAgain);
            showMoreBtn.addEventListener('click', toggleAdvancedAnalysis);
            randomPracticeBtn.addEventListener('click', handleRandomPractice);
            textInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    fetchAndDisplayIPA();
                }
            });
        }

        init();
    </script>
</body>
</html>
